{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "region": {
      "type": "string",
      "allowedValues": [
        "East US",
        "West US",
        "North Europe",
        "West Europe",
        "East Asia",
        "South East Asia",
        "Japan East",
        "Japan West",
        "Australia East",
        "Australia SouthEast",
        "North Europe"
      ],
      "metadata": {
        "description": "The Region to deploy the solution to"
      }
    },
    "solutionName": {
      "type": "string",
      "maxLength": 16,
      "metadata": {
        "description": "The name of your ConnectTheDots solution (will be used to prefix the services names)"
      }
    },
    "iotHubSku": {
      "type": "string",
      "allowedValues": [
        "F1",
        "S1",
        "S2"
      ],
      "defaultValue": "S1",
      "metadata": {
        "description": "The Iothub Sku"
      }
    },
    "adminName": {
      "type": "string",
      "defaultValue": "akvelon"
    },
    "adminPassword": {
      "type": "securestring",
      "defaultValue": "Frdb_Kjy"
    },
    "repoUrl": {
      "type": "string",
      "defaultValue": "https://github.com/dmytokrivoruchenko/telemetry/"
    },
    "branch": {
      "type": "string",
      "defaultValue": "tel/test"
    }
  },
  "variables": {
    "location": "[parameters('region')]",
    "sqlServerVersion": "2014-04-01-preview",
    "sqlServerName": "[concat(parameters('solutionName'), 'srv')]",
    "sqlLog": "[parameters('adminName')]",
    "sqlPas": "[parameters('adminPassword')]",
    "sbVersion": "[providers('Microsoft.Eventhub', 'namespaces').apiVersions[0]]",
    "ehOutName": "ehalerts",
    "sbKeyName": "RootManageSharedAccessKey",
    "sbSku": 1,
    "storageVersion": "2015-06-15",
    "test": "eaebb4d7-8feb-4b8c-9bee-8495649ec031",
    "test2": "db7cde72-b5cf-438b-8e8c-3d72012b7a24",
    "storageName": "[concat(parameters('solutionName'), 'storage')]",
    //"storageId": "[resourceId('Microsoft.Storage/storageAccounts/akvelon')]",
    "storageAccountSku": "Standard_LRS",
    "sbName": "[concat(parameters('solutionName'),'sb')]",
    "sbResourceId": "[resourceId('Microsoft.Eventhub/namespaces/authorizationRules', variables('sbName'), variables('sbKeyName'))]",
    "saVersion": "2015-10-01",
    "saName": "[concat(parameters('solutionName'), 'alerts')]",
    "webVersion": "2015-04-01",
    "webPlanName": "[concat(parameters('solutionName'), 'plan')]",
    "webSiteName": "[parameters('solutionName')]",
    "iotHubVersion": "2016-02-03",
    "srtVersion":"2016-12-01",
    "iotHubTier": "Standard",
    "iotHubName": "[concat(parameters('solutionName'), 'hub')]",
    "iotHubResourceId": "[resourceId('Microsoft.Devices/Iothubs', variables('iotHubName'))]",
    "iotHubKeyName": "iothubowner",
    "iotHubKeyResource": "[resourceId('Microsoft.Devices/Iothubs/Iothubkeys', variables('iotHubName'), variables('iotHubKeyName'))]",
    "saCGName": "streamanalyticscg",
    "websiteCGName": "websitecg",
    "webSku": "Standard",
    "webWorkerCount": 2,
    "webWorkerSize": 0,
    "storageKeyType": "SharedAccessKey",
    "storageKey" : "f34b903ff4907b443cc10f85bb3e6ccfd4d960de"
  },
  "resources": [
    {
      "apiVersion": "[variables('webVersion')]",
      "name": "[variables('webPlanName')]",
      "type": "Microsoft.Web/serverfarms",
      "location": "[variables('location')]",
      "tags": {
        "displayName": "Web Plan"
      },
      "properties": {
        "name": "[variables('webPlanName')]",
        "sku": "[variables('webSku')]",
        "workerSize": "[variables('webWorkerSize')]",
        "numberOfWorkers": "[variables('webWorkerCount')]"
      }
    },
      {
        "name": "[variables('sqlServerName')]",
        "type": "Microsoft.Sql/servers",
        "location": "[variables('location')]",
        "apiVersion": "[variables('sqlServerVersion')]",
        "tags": {
          "displayName": "SQLServer"
        },
        "properties": {
          "administratorLogin": "[variables('sqlLog')]",
          "administratorLoginPassword": "[variables('sqlPas')]"
        },
        "resources": [
          {
            "name": "AllowAllWindowsAzureIps",
            "type": "firewallrules",
            "location": "[variables('location')]",
            "apiVersion": "[variables('sqlServerVersion')]",
            "dependsOn": [
              "[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]"
            ],
            "properties": {
              "startIpAddress": "0.0.0.0",
              "endIpAddress": "255.255.255.255"
            }
          },
          {
            "name": "master",
            "type": "databases",
            "apiVersion": "[variables('sqlServerVersion')]",
            "location": "[variables('location')]",
            "properties": {
              "edition": "Basic",
              "collation": "SQL_Latin1_General_CP1_CI_AS",
              "maxSizeBytes": "2147483648",
              "requestedServiceObjectiveName": "Basic"
            },
            "dependsOn": [
              "[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]"
            ]
          },
          {
            "name": "telemetry",
            "type": "databases",
            "location": "[variables('location')]",
            "apiVersion": "[variables('sqlServerVersion')]",
            "dependsOn": [
              "[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]"
            ],
            "tags": {
              "displayName": "telemetry"
            },
            "properties": {
              "collation": "SQL_Latin1_General_CP1_CI_AS",
              "edition": "Basic",
              "maxSizeBytes": "1073741824",
              "requestedServiceObjectiveName": "Basic"
            },
            "resources": [
              {
                "name": "Import",
                "type": "extensions",
                "apiVersion": "[variables('sqlServerVersion')]",
                "dependsOn": [
                  "[concat('Microsoft.Sql/servers/', variables('sqlServerName'),'/databases/telemetry')]"
                ],
                "properties": {
                  "storageKeyType": "SharedAccessKey",
                  "storageKey": "AuB3blT7NApBDnslygq+PSCwX98Y3zK0nhX6K9T7zZiVR3QwM+hyzjf8Iawg3ed7551lvzC3shthJazsMsno5A==",
                  "storageUri": "https://akvelon.blob.core.windows.net/akvelonbc/telemetry.bacpac",
                  "administratorLogin": "akvelon",
                  "administratorLoginPassword": "Frdb_Kjy",
                  "operationMode": "Import"
                }
              }
            ]
          }
        ]
    },
    {
      "name": "[variables('webSiteName')]",
      "type": "Microsoft.Web/sites",
      "location": "[variables('location')]",
      "apiVersion": "[variables('webVersion')]",
      "dependsOn": [
        "[concat('Microsoft.Web/serverfarms/', variables('webPlanName'))]"
        ],
      "properties": {
        "name": "[variables('WebSiteName')]",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms/', variables('webPlanName'))]",
        "siteConfig": {
          "AlwaysOn": true,
          "WebsocketsEnabled": true,
          "appSettings": [
            {
              "name": "TelemetryConnection",
              "value": "[concat('Server=tcp:', variables('sqlServerName'), '.database.windows.net,1433;Initial Catalog=telemetry;Persist Security Info=False;User ID=', variables('sqlLog'), ';Password=', variables('sqlPas'), ';MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')]"
            },
            {
              "name": "AdminName",
              "value": "[variables('sqlLog')]"
            },
            {
              "name": "AdminPassword",
              "value": "[variables('sqlPas')]"
            },
            {
              "name": "SolutionName",
              "value": "[variables('webSiteName')]"
            }
          ],
          "connectionStrings" :[{
              "name": "TelemetryConnection",
              "connectionString": "[concat('Server=tcp:', variables('sqlServerName'), '.database.windows.net,1433;Initial Catalog=telemetry;Persist Security Info=False;User ID=', variables('sqlLog'), ';Password=', variables('sqlPas'), ';MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')]",
              "type": "SQLServer"
            }
            ]
        }
      },
      "resources": [
        {
          "apiVersion":"[variables('webVersion')]",
          "name":"web",
          "type":"sourcecontrols",
          "dependsOn":[
            "[concat('Microsoft.Web/sites/', variables('webSiteName'))]"
          ],
          "properties":{
            "TelemetryConnection":{
              "value": "[concat('Server=tcp:', variables('sqlServerName'), '.database.windows.net,1433;Initial Catalog=telemetry;Persist Security Info=False;User ID=', variables('sqlLog'), ';Password=', variables('sqlPas'), ';MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')]",
              "type": "SQLServer"
            },
            "repoUrl":"https://github.com/dmytokrivoruchenko/telemetry/tree/tel/test/src/smart/SmartOffice",
            "branch":"tel/test",
            "isManualIntegration": true
          }
        }
      ]
    }
  ],
  "outputs": {
    "TelemetryConnection": {
      "type": "string",
      "value": "[concat('Server=tcp:', variables('sqlServerName'), '.database.windows.net,1433;Initial Catalog=telemetry;Persist Security Info=False;User ID=', variables('sqlLog'), ';Password=', variables('sqlPas'), ';MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')]"
    }
  }
}